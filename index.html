<html lang="vi"><head><script>(function(firebaseConfig, initialAuthToken, appId) {
        window.__firebase_config = firebaseConfig;
        window.__initial_auth_token = initialAuthToken;
        window.__app_id = appId;
            })("\n{\n  \"apiKey\": \"AIzaSyCqyCcs2R2e7AegGjvFAwG98wlamtbHvZY\",\n  \"authDomain\": \"bard-frontend.firebaseapp.com\",\n  \"projectId\": \"bard-frontend\",\n  \"storageBucket\": \"bard-frontend.firebasestorage.app\",\n  \"messagingSenderId\": \"175205271074\",\n  \"appId\": \"1:175205271074:web:2b7bd4d34d33bf38e6ec7b\"\n}\n","eyJhbGciOiJSUzI1NiIsImtpZCI6ImE3ZTI3MWMzMmJkMTBkY2EwNTExOThmNjkwNjc3MGEzN2Q0MmRhM2IiLCJ0eXAiOiJKV1QifQ.eyJzdWIiOiJmaXJlYmFzZS1hZG1pbnNkay1mYnN2Y0BiYXJkLWZyb250ZW5kLmlhbS5nc2VydmljZWFjY291bnQuY29tIiwiYXVkIjoiaHR0cHM6Ly9pZGVudGl0eXRvb2xraXQuZ29vZ2xlYXBpcy5jb20vZ29vZ2xlLmlkZW50aXR5LmlkZW50aXR5dG9vbGtpdC52MS5JZGVudGl0eVRvb2xraXQiLCJ1aWQiOiIxMjg5NTgxNTY3OTc2NjgwNzczMCIsImlzcyI6ImZpcmViYXNlLWFkbWluc2RrLWZic3ZjQGJhcmQtZnJvbnRlbmQuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLCJjbGFpbXMiOnsiYXBwSWQiOiJjXzJkZDA5YTExOTQ5MWRkMzNfUmFuZG9tUGlja2VyX1Y3LjMuaHRtbC04MTEifSwiZXhwIjoxNzY4MzY0MTI5LCJpYXQiOjE3NjgzNjA1MjksImFsZyI6IlJTMjU2In0.TlftLgHPE-JOjqxFkOHvxBYlDfneOwIwkq_DUBLfHfAI_fGkkyoNw3hIMEgFUXp491ZMqkNWjhQTPHLicJvco0hZVYLUhEcFISta4iYPBK3Wqm07UWIxUYNpIXPNZhNIJbPSEQam_Ykatd5t1J4TC2ekx1C8HLkbMuuSplr2BICd_KA1GuqpWDzMPFOJItIR9PKNBCsmN56K226Zci-hNIajS6eV18rB_-14kNklizijfUpBB29inWcnSx28ASM2wzruoY2OPA3W15sTr8k41xp2SzeuemPWrHXz9nRcvyZuKeHsvgRcfsvxn1vsn6atR6Ng6gh1L6EXQC7JHzPWlw","c_2dd09a119491dd33_RandomPicker_V7.3.html-811")</script><script>'use strict';var h=typeof Object.defineProperties=="function"?Object.defineProperty:function(a,b,d){if(a==Array.prototype||a==Object.prototype)return a;a[b]=d.value;return a};function l(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<a.length;++b){var d=a[b];if(d&&d.Math==Math)return d}throw Error("Cannot find global object");}var n=l(this);
function p(a,b){if(b)a:{var d=n;a=a.split(".");for(var c=0;c<a.length-1;c++){var e=a[c];if(!(e in d))break a;d=d[e]}a=a[a.length-1];c=d[a];b=b(c);b!=c&&b!=null&&h(d,a,{configurable:!0,writable:!0,value:b})}}function r(a){function b(c){return a.next(c)}function d(c){return a.throw(c)}return new Promise(function(c,e){function f(g){g.done?c(g.value):Promise.resolve(g.value).then(b,d).then(f,e)}f(a.next())})}function t(a){return r(a())}
p("Object.values",function(a){return a?a:function(b){var d=[],c;for(c in b)Object.prototype.hasOwnProperty.call(b,c)&&d.push(b[c]);return d}});p("Array.prototype.includes",function(a){return a?a:function(b,d){var c=this;c instanceof String&&(c=String(c));var e=c.length;d=d||0;for(d<0&&(d=Math.max(d+e,0));d<e;d++){var f=c[d];if(f===b||Object.is(f,b))return!0}return!1}});/*

 MIT License

 Copyright (c) 2017-2023 W.Y.

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the "Software"), to deal
 in the Software without restriction, including without limitation the rights
 to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:

 The above copyright notice and this permission notice shall be included in
 all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 SOFTWARE.

*/
function u(a,b){const d=a.style;b.backgroundColor&&(d.backgroundColor=b.backgroundColor);b.width&&(d.width=`${b.width}px`);b.height&&(d.height=`${b.height}px`);const c=b.style;c!=null&&Object.keys(c).forEach(e=>{d[e]=c[e]})};var v=(()=>{let a=0;return()=>{a+=1;return`u${`0000${(Math.random()*1679616<<0).toString(36)}`.slice(-4)}${a}`}})();function w(a){const b=[];for(let d=0,c=a.length;d<c;d++)b.push(a[d]);return b}let x=null;function y(a={}){return x?x:a.l?x=a.l:x=w(window.getComputedStyle(document.documentElement))}function z(a,b){return(a=(a.ownerDocument.defaultView||window).getComputedStyle(a).getPropertyValue(b))?parseFloat(a.replace("px","")):0}
function A(a,b={}){var d;if(!(d=b.width)){d=z(a,"border-left-width");var c=z(a,"border-right-width");d=a.clientWidth+d+c}(b=b.height)||(b=z(a,"border-top-width"),c=z(a,"border-bottom-width"),b=a.clientHeight+b+c);return{width:d,height:b}}function B(a){return new Promise((b,d)=>{const c=new Image;c.onload=()=>{c.decode().then(()=>{requestAnimationFrame(()=>b(c))})};c.onerror=d;c.crossOrigin="anonymous";c.decoding="async";c.src=a})}
function C(a){return t(function*(){return Promise.resolve().then(()=>(new XMLSerializer).serializeToString(a)).then(encodeURIComponent).then(b=>`data:image/svg+xml;charset=utf-8,${b}`)})}
function D(a,b,d){return t(function*(){const c=document.createElementNS("http://www.w3.org/2000/svg","svg"),e=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");c.setAttribute("width",`${b}`);c.setAttribute("height",`${d}`);c.setAttribute("viewBox",`0 0 ${b} ${d}`);e.setAttribute("width","100%");e.setAttribute("height","100%");e.setAttribute("x","0");e.setAttribute("y","0");e.setAttribute("externalResourcesRequired","true");c.appendChild(e);e.appendChild(a);return C(c)})}
var E=(a,b)=>{if(a instanceof b)return!0;a=Object.getPrototypeOf(a);return a===null?!1:a.constructor.name===b.name||E(a,b)};function F(a,b){return y(b).map(d=>{const c=a.getPropertyValue(d),e=a.getPropertyPriority(d);return`${d}: ${c}${e?" !important":""};`}).join(" ")}
function G(a,b,d,c){a=window.getComputedStyle(a,d);var e=a.getPropertyValue("content");if(e!==""&&e!=="none"){var f=v();try{b.className=`${b.className} ${f}`}catch(k){return}e=document.createElement("style");var g=e.appendChild;d=`.${f}:${d}`;a.cssText?(c=a.getPropertyValue("content"),c=`${a.cssText} content: '${c.replace(/'|"/g,"")}';`):c=F(a,c);g.call(e,document.createTextNode(`${d}{${c}}`));b.appendChild(e)}};function H(a){return a.search(/^(data:)/)!==-1}function I(a,b,d){return t(function*(){const c=yield fetch(a,b);if(c.status===404)throw Error(`Resource "${c.url}" not found`);const e=yield c.blob();return new Promise((f,g)=>{const k=new FileReader;k.onerror=g;k.onloadend=()=>{try{f(d({o:c,result:k.result}))}catch(m){g(m)}};k.readAsDataURL(e)})})}const J={};function K(a,b,d){let c=a.replace(/\?.*/,"");d&&(c=a);/ttf|otf|eot|woff2?/i.test(c)&&(c=c.replace(/.*\//,""));return b?`[${b}]${c}`:c}
function L(a,b,d){return t(function*(){const c=K(a,b,d.C);if(J[c]!=null)return J[c];d.u&&(a+=(/\?/.test(a)?"&":"?")+(new Date).getTime());let e;try{const f=yield I(a,d.i,({o:g,result:k})=>{b||(b=g.headers.get("Content-Type")||"");return k.split(/,/)[1]});e=`data:${b};base64,${f}`}catch(f){e=d.B||""}return J[c]=e})};const M={P:"application/font-woff",R:"application/font-woff",N:"application/font-truetype",v:"application/vnd.ms-fontobject",H:"image/png",F:"image/jpeg",D:"image/jpeg",A:"image/gif",M:"image/tiff",L:"image/svg+xml",O:"image/webp"};function N(a){return(a=/\.([^./]*?)$/g.exec(a))?a[1]:""};function O(a){return t(function*(){const b=a.toDataURL();return b==="data:,"?a.cloneNode(!1):B(b)})}function aa(a,b){return t(function*(){if(a.currentSrc){var d=document.createElement("canvas");const c=d.getContext("2d");d.width=a.clientWidth;d.height=a.clientHeight;c==null||c.drawImage(a,0,0,d.width,d.height);d=d.toDataURL();return B(d)}d=a.poster;d=yield L(d,M[N(d).toLowerCase()]||"",b);return B(d)})}
function ba(a,b){return t(function*(){try{let d;if(a==null?0:(d=a.contentDocument)==null?0:d.body)return yield P(a.contentDocument.body,b,!0)}catch(d){}return a.cloneNode(!1)})}function ca(a,b){return t(function*(){return E(a,HTMLCanvasElement)?O(a):E(a,HTMLVideoElement)?aa(a,b):E(a,HTMLIFrameElement)?ba(a,b):a.cloneNode(a.tagName!=null&&a.tagName.toUpperCase()==="SVG")})}
function da(a,b,d){return t(function*(){if(b.tagName!=null&&b.tagName.toUpperCase()==="SVG")return b;let c=[];if(a.tagName!=null&&a.tagName.toUpperCase()==="SLOT"&&a.assignedNodes)c=w(a.assignedNodes());else{let e;if(E(a,HTMLIFrameElement)&&((e=a.contentDocument)==null?0:e.body))c=w(a.contentDocument.body.childNodes);else{let f;c=w(((f=a.shadowRoot)!=null?f:a).childNodes)}}if(c.length===0||E(a,HTMLVideoElement))return b;yield c.reduce((e,f)=>e.then(()=>P(f,d)).then(g=>{g&&b.appendChild(g)}),Promise.resolve());
return b})}function ea(a,b,d){const c=b.style;if(c){var e=window.getComputedStyle(a);e.cssText?(c.cssText=e.cssText,c.transformOrigin=e.transformOrigin):y(d).forEach(f=>{let g=e.getPropertyValue(f);f==="font-size"&&g.endsWith("px")&&(g=`${Math.floor(parseFloat(g.substring(0,g.length-2)))-.1}px`);E(a,HTMLIFrameElement)&&f==="display"&&g==="inline"&&(g="block");f==="d"&&b.getAttribute("d")&&(g=`path(${b.getAttribute("d")})`);c.setProperty(f,g,e.getPropertyPriority(f))})}}
function fa(a,b){E(a,HTMLSelectElement)&&(b=Array.from(b.children).find(d=>a.value===d.getAttribute("value")))&&b.setAttribute("selected","")}
function ha(a,b){return t(function*(){var d=a.querySelectorAll?a.querySelectorAll("use"):[];if(d.length===0)return a;var c={};for(var e=0;e<d.length;e++){var f=d[e].getAttribute("xlink:href");if(f){const g=document.querySelector(f);a.querySelector(f)||!g||c[f]||(c[f]=yield P(g,b,!0))}}d=Object.values(c);if(d.length){c=document.createElementNS("http://www.w3.org/1999/xhtml","svg");c.setAttribute("xmlns","http://www.w3.org/1999/xhtml");c.style.position="absolute";c.style.width="0";c.style.height="0";
c.style.overflow="hidden";c.style.display="none";e=document.createElementNS("http://www.w3.org/1999/xhtml","defs");c.appendChild(e);for(f=0;f<d.length;f++)e.appendChild(d[f]);a.appendChild(c)}return a})}
function P(a,b,d){return t(function*(){return d||!b.filter||b.filter(a)?Promise.resolve(a).then(c=>ca(c,b)).then(c=>da(a,c,b)).then(c=>{E(c,Element)&&(ea(a,c,b),G(a,c,":before",b),G(a,c,":after",b),E(a,HTMLTextAreaElement)&&(c.textContent=a.value),E(a,HTMLInputElement)&&c.setAttribute("value",a.value),fa(a,c));return c}).then(c=>ha(c,b)):null})};const Q=/url\((['"]?)([^'"]+?)\1\)/g,ia=/url\([^)]+\)\s*format\((["']?)([^"']+)\1\)/g,ja=/src:\s*(?:url\([^)]+\)\s*format\([^)]+\)[,;]\s*)+/g;function ka(a){const b=[];a.replace(Q,(d,c,e)=>{b.push(e);return d});return b.filter(d=>!H(d))}
function la(a,b,d,c){return t(function*(){try{const e=d?(new URL(b,d||void 0)).toString():b;let f;f=yield L(e,M[N(b).toLowerCase()]||"",c);return a.replace(new RegExp(`(url\\(['"]?)(${b.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1")})(['"]?\\))`,"g"),`$1${f}$3`)}catch(e){}return a})}function ma(a,{I:b}){return b?a.replace(ja,d=>{for(;;){const [c,,e]=ia.exec(d)||[],f=c,g=e;if(!g)return"";if(g===b)return`src: ${f};`}}):a}
function R(a,b,d){return t(function*(){if(a.search(Q)===-1)return a;const c=ma(a,d);return ka(c).reduce((e,f)=>e.then(g=>la(g,f,b,d)),Promise.resolve(c))})};function S(a,b,d){return t(function*(){var c;const e=(c=b.style)==null?void 0:c.getPropertyValue(a);return e?(c=yield R(e,null,d),b.style.setProperty(a,c,b.style.getPropertyPriority(a)),!0):!1})}function na(a,b){return t(function*(){(yield S("background",a,b))||(yield S("background-image",a,b));(yield S("mask",a,b))||(yield S("-webkit-mask",a,b))||(yield S("mask-image",a,b))||(yield S("-webkit-mask-image",a,b))})}
function oa(a,b){return t(function*(){const d=E(a,HTMLImageElement);if(d&&!H(a.src)||E(a,SVGImageElement)&&!H(a.href.baseVal)){var c=d?a.src:a.href.baseVal,e=yield L(c,M[N(c).toLowerCase()]||"",b);yield new Promise((f,g)=>{a.onload=f;a.onerror=b.m?(...k)=>{try{f(b.m(...k))}catch(m){g(m)}}:g;a.decode&&(a.decode=f);a.loading==="lazy"&&(a.loading="eager");d?(a.srcset="",a.src=e):a.href.baseVal=e})}})}
function pa(a,b){return t(function*(){const d=w(a.childNodes).map(c=>T(c,b));yield Promise.all(d).then(()=>a)})}function T(a,b){return t(function*(){E(a,Element)&&(yield na(a,b),yield oa(a,b),yield pa(a,b))})};const U={};function V(a){return t(function*(){var b=U[a];if(b!=null)return b;b=yield(yield fetch(a)).text();b={url:a,cssText:b};return U[a]=b})}function W(a,b){return t(function*(){let d=a.cssText;const c=/url\(["']?([^"')]+)["']?\)/g,e=(d.match(/url\([^)]+\)/g)||[]).map(f=>t(function*(){let g=f.replace(c,"$1");g.startsWith("https://")||(g=(new URL(g,a.url)).href);return I(g,b.i,({result:k})=>{d=d.replace(f,`url(${k})`);return[f,k]})}));return Promise.all(e).then(()=>d)})}
function X(a){if(a==null)return[];const b=[];a=a.replace(/(\/\*[\s\S]*?\*\/)/gi,"");for(var d=RegExp("((@.*?keyframes [\\s\\S]*?){([\\s\\S]*?}\\s*?)})","gi");;){var c=d.exec(a);if(c===null)break;b.push(c[0])}a=a.replace(d,"");d=/@import[\s\S]*?url\([^)]*\)[\s\S]*?;/gi;for(c=RegExp("((\\s*?(?:\\/\\*[\\s\\S]*?\\*\\/)?\\s*?@media[\\s\\S]*?){([\\s\\S]*?)}\\s*?})|(([\\s\\S]*?){([\\s\\S]*?)})","gi");;){let e=d.exec(a);if(e===null)if(e=c.exec(a),e===null)break;else d.lastIndex=c.lastIndex;else c.lastIndex=
d.lastIndex;b.push(e[0])}return b}
function qa(a,b){return t(function*(){const d=[],c=[];a.forEach(e=>{if("cssRules"in e)try{w(e.cssRules||[]).forEach((f,g)=>{if(f.type===CSSRule.IMPORT_RULE){let k=g+1;f=V(f.href).then(m=>W(m,b)).then(m=>X(m).forEach(q=>{try{e.insertRule(q,q.startsWith("@import")?k+=1:e.cssRules.length)}catch(Da){}})).catch(()=>{});c.push(f)}})}catch(f){const g=a.find(k=>k.href==null)||document.styleSheets[0];e.href!=null&&c.push(V(e.href).then(k=>W(k,b)).then(k=>X(k).forEach(m=>{g.insertRule(m,g.cssRules.length)})).catch(()=>
{}))}});return Promise.all(c).then(()=>{a.forEach(e=>{if("cssRules"in e)try{w(e.cssRules||[]).forEach(f=>{d.push(f)})}catch(f){}});return d})})}function ra(a){return a.filter(b=>b.type===CSSRule.FONT_FACE_RULE).filter(b=>b.style.getPropertyValue("src").search(Q)!==-1)}function sa(a,b){return t(function*(){if(a.ownerDocument==null)throw Error("Provided element is not within a Document");var d=w(a.ownerDocument.styleSheets);d=yield qa(d,b);return ra(d)})}
function ta(a){function b(c){(c.style.fontFamily||getComputedStyle(c).fontFamily).split(",").forEach(e=>{d.add(e.trim().replace(/["']/g,""))});Array.from(c.children).forEach(e=>{e instanceof HTMLElement&&b(e)})}const d=new Set;b(a);return d}function ua(a,b){return t(function*(){const d=yield sa(a,b),c=ta(a);return(yield Promise.all(d.filter(e=>c.has(e.style.fontFamily.trim().replace(/["']/g,""))).map(e=>R(e.cssText,e.parentStyleSheet?e.parentStyleSheet.href:null,b)))).join("\n")})}
function va(a,b){return t(function*(){const d=b.j!=null?b.j:b.K?null:yield ua(a,b);if(d){const c=document.createElement("style");c.appendChild(document.createTextNode(d));a.firstChild?a.insertBefore(c,a.firstChild):a.appendChild(c)}})};function wa(a,b={}){return t(function*(){const {width:d,height:c}=A(a,b),e=yield P(a,b,!0);yield va(e,b);yield T(e,b);u(e,b);return yield D(e,d,c)})}
function xa(a,b={}){return t(function*(){const {width:d,height:c}=A(a,b);var e=yield wa(a,b);e=yield B(e);const f=document.createElement("canvas"),g=f.getContext("2d"),k=b.G||window.devicePixelRatio||1,m=b.h||d,q=b.g||c;f.width=m*k;f.height=q*k;!b.J&&(f.width>16384||f.height>16384)&&(f.width>16384&&f.height>16384?f.width>f.height?(f.height*=16384/f.width,f.width=16384):(f.width*=16384/f.height,f.height=16384):f.width>16384?(f.height*=16384/f.width,f.width=16384):(f.width*=16384/f.height,f.height=
16384));f.style.width=`${m}`;f.style.height=`${q}`;b.backgroundColor&&(g.fillStyle=b.backgroundColor,g.fillRect(0,0,f.width,f.height));g.drawImage(e,0,0,f.width,f.height);return f})}function ya(a,b={}){return t(function*(){return(yield xa(a,b)).toDataURL()})};const za=["gemini.google.com","corp.google.com","proxy.googlers.com"];function Y(){return document.body.querySelectorAll('[class*="animate"]').length>0}function Z(a){return t(function*(){try{return yield ya(a,{h:a.offsetWidth,g:a.offsetHeight})}catch(d){var b=a.offsetHeight;const c=document.createElement("canvas");c.width=a.offsetWidth;c.height=b;return c.toDataURL("image/png")}})}
function Aa(){return t(function*(){const a=document.body.offsetWidth,b=document.body.offsetHeight,d=document.body.cloneNode(!0);d.querySelectorAll('[class*="animate"]').forEach(c=>{c.classList.remove(...Array.from(c.classList).filter(e=>e.startsWith("animate")))});d.style.width=`${a}px`;d.style.height=`${b}px`;return d})}
function Ba(a){return t(function*(){let b=document.body;if(Y()){var d=yield Aa();b=d;document.body.appendChild(d)}d=yield Z(b);Y()&&document.body.removeChild(b);window.parent.postMessage({type:"SEND_SCREENSHOT",image:d,topOffset:document.documentElement.scrollTop},a.origin)})}function Ca(a){return t(function*(){const b={type:"SEND_SCREENSHOT_FOR_DATA_VISUALIZATION",image:yield Z(document.body),topOffset:0};window.parent.postMessage(b,a.origin)})}
window.addEventListener("message",a=>t(function*(){if(za.some(d=>a.origin.includes(d))){var b=a.data;b&&(b.type==="MAKE_SCREENSHOT"&&(yield Ba(a)),b.type==="MAKE_SCREENSHOT_FOR_DATA_VISUALIZATION"&&(yield Ca(a)))}}));
</script><script>(function() {
  // Ensure this script is executed only once
  if (window.firebaseAuthBridgeScriptLoaded) {
    return;
  }
  window.firebaseAuthBridgeScriptLoaded = true;

  let nextTokenPromiseId = 0;

  // Stores { resolve, reject } for ongoing token requests
  const pendingTokenPromises = {};

  // Listen for messages from the Host Application
  window.addEventListener('message', function(event) {

    const messageData = event.data;

  if (messageData && messageData.type === 'RESOLVE_NEW_FIREBASE_TOKEN') {
      const { success, token, error, promiseId } = messageData ?? {};
      if (pendingTokenPromises[promiseId]) {
        if (success) {
          pendingTokenPromises[promiseId].resolve(token);
        } else {
          pendingTokenPromises[promiseId].reject(new Error(error || 'Token refresh failed from host.'));
        }
        delete pendingTokenPromises[promiseId];
      }
    }
  });

  // Expose a function for the Generated App to request a new Firebase token
  window.requestNewFirebaseToken = function() {
    const currentPromiseId = nextTokenPromiseId++;
    const promise = new Promise((resolve, reject) => {
      pendingTokenPromises[currentPromiseId] = { resolve, reject };
    });
    if (window.parent && window.parent !== window) {
      window.parent.postMessage({
        type: 'REQUEST_NEW_FIREBASE_TOKEN',
        promiseId: currentPromiseId
      }, '*');
    } else {
      pendingTokenPromises[currentPromiseId].reject(new Error('No parent window to request token from.'));
      delete pendingTokenPromises[currentPromiseId];
    }
    return promise;
  };
})();</script><script>
let realOriginalGetUserMedia = null;
if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
  realOriginalGetUserMedia = navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);
}

(function() {
  if (navigator.mediaDevices && navigator.mediaDevices.__proto__) {
    try {
      Object.defineProperty(navigator.mediaDevices.__proto__, 'getUserMedia', {
        get: function() {
          return undefined; // Or throw an error
        },
        configurable: false
      });
    } catch (error) {
      console.error("Error defining prototype getter:", error);
    }
  }
})();

(function() {
  const pendingMediaResolvers = {};
  let nextMediaPromiseId = 0;

  function requestMediaPermissions(constraints) {
    const mediaPromiseId = nextMediaPromiseId++;
    const promise = new Promise((resolve, reject) => {
      pendingMediaResolvers[mediaPromiseId] = (granted) => {
        delete pendingMediaResolvers[mediaPromiseId];
        resolve(granted);
      };
    });

    window.parent.postMessage({
      type: 'requestMediaPermission',
      constraints: constraints,
      promiseId: mediaPromiseId,
    }, '*');

    return promise;
  }

  let originalGetUserMedia = realOriginalGetUserMedia;

  function interceptGetUserMedia() {
    if (navigator.mediaDevices) {
      Object.defineProperty(navigator.mediaDevices, 'getUserMedia', {
        value: function(constraints) {
          return requestMediaPermissions(constraints).then((granted) => {
            if (granted) {
              if (originalGetUserMedia) {
                return originalGetUserMedia(constraints);
              } else {
                throw new Error("Original getUserMedia not available.");
              }
            } else {
              throw new DOMException('Permission denied', 'NotAllowedError');
            }
          });
        },
        writable: false,
        configurable: false
      });
    }
  }

  interceptGetUserMedia();

  const observer = new MutationObserver(function(mutationsList, observer) {
    for (const mutation of mutationsList) {
      if (mutation.type === 'reconfigured' && mutation.name === 'getUserMedia' && mutation.object === navigator.mediaDevices) {
        interceptGetUserMedia();
      } else if (mutation.type === 'attributes' && mutation.attributeName === 'getUserMedia' && mutation.target === navigator.mediaDevices) {
        interceptGetUserMedia();
      } else if (mutation.type === 'childList' && mutation.addedNodes) {
        mutation.addedNodes.forEach(node => {
          if (node === navigator.mediaDevices) {
            interceptGetUserMedia();
          }
        });
      }
    }
  });

  function interceptSpeechRecognition() {
    if (!window.SpeechRecognition && !window.webkitSpeechRecognition) {
      return;
    }

    const OriginalSpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    const SpeechRecognitionWrapper = function(...args) {
      const recognizer = new OriginalSpeechRecognition(...args);
      const originalStart = recognizer.start.bind(recognizer);

      recognizer.start = function() {
        requestMediaPermissions({ audio: true }).then(granted => {
          if (granted) {
            originalStart();
          } else {
            const errorEvent = new SpeechRecognitionErrorEvent('error');
            errorEvent.error = 'not-allowed'; // This is the standard error for permission denial.
            recognizer.dispatchEvent(errorEvent);
          }
        });
      };

      return recognizer;
    };

    SpeechRecognitionWrapper.prototype = OriginalSpeechRecognition.prototype;
    SpeechRecognitionWrapper.prototype.constructor = SpeechRecognitionWrapper;

    if (window.SpeechRecognition) {
      window.SpeechRecognition = SpeechRecognitionWrapper;
    }
    if (window.webkitSpeechRecognition) {
      window.webkitSpeechRecognition = SpeechRecognitionWrapper;
    }
  }

  interceptSpeechRecognition();

  window.addEventListener('message', function(event) {
    if (event.data) {
      if (event.data.type === 'resolveMediaPermission') {
        const { promiseId, granted } = event.data;
        if (pendingMediaResolvers[promiseId]) {
          pendingMediaResolvers[promiseId](granted);
        }
      }
    }
  });

})();</script><script>((function(modelInformation) {
  const originalFetch = window.fetch;
  // TODO: b/421908508 - Move these out of the script and match all generative AI model calls.
  let googleLlmBaseApiUrls = [
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.textModelName + ':streamGenerateContent',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.textModelName + ':generateContent',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.imageModelName + ':predict',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.imageModelName + ':predictLongRunning',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.imageEditModelName + ':generateContent',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.imageTransformModelName + ':generateContent',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.videoModelName + ':predict',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.videoModelName + ':predictLongRunning',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.ttsModelName + ':generateContent',
  ];
  modelInformation.deprecatedTextModelNames.forEach((modelName) => {
    googleLlmBaseApiUrls.push(
      'https://generativelanguage.googleapis.com/v1beta/models/' + modelName + ':streamGenerateContent',
      'https://generativelanguage.googleapis.com/v1beta/models/' + modelName + ':generateContent',
    );
  });
  modelInformation.deprecatedImageModelNames.forEach((modelName) => {
    googleLlmBaseApiUrls.push(
      'https://generativelanguage.googleapis.com/v1beta/models/' + modelName + ':predict',
      'https://generativelanguage.googleapis.com/v1beta/models/' + modelName + ':predictLongRunning',
    );
  });

  const pendingFetchResolvers = {};
  let nextPromiseId = 0;

  function handleStringInput(input, optionsArgument) {
    const actualUrl = input;
    const fetchCallArgs = [actualUrl, optionsArgument];
    const effectiveOptions = optionsArgument || {};
    const bodyForApiKeyCheck = effectiveOptions.body;
    const bodyForPostMessage = effectiveOptions.body;
    return { actualUrl, fetchCallArgs, effectiveOptions, bodyForApiKeyCheck, bodyForPostMessage };
  }

  function handleRequestInput(input, optionsArgument) {
    const actualUrl = input.url;
    const fetchCallArgs = [input, optionsArgument];
    const effectiveOptions = { method: input.method, headers: new Headers(input.headers) };
    let bodyForApiKeyCheck;
    let bodyForPostMessage;

    if (optionsArgument) {
      if (optionsArgument.method) effectiveOptions.method = optionsArgument.method;
      if (optionsArgument.headers) effectiveOptions.headers = new Headers(optionsArgument.headers);
      if ('body' in optionsArgument) {
        bodyForApiKeyCheck = optionsArgument.body;
        bodyForPostMessage = optionsArgument.body;
      } else {
        bodyForApiKeyCheck = undefined;
        bodyForPostMessage = input.body;
      }
    } else {
      bodyForApiKeyCheck = undefined;
      bodyForPostMessage = input.body;
    }
    return { actualUrl, fetchCallArgs, effectiveOptions, bodyForApiKeyCheck, bodyForPostMessage };
  }

  window.fetch = function(input, optionsArgument) {
    let actualUrl;
    let fetchCallArgs;
    let effectiveOptions = {};
    let bodyForApiKeyCheck;
    let bodyForPostMessage;

    if (typeof input === 'string') {
      ({actualUrl, fetchCallArgs, effectiveOptions, bodyForApiKeyCheck, bodyForPostMessage} = handleStringInput(input, optionsArgument));
    } else if (input instanceof Request) {
      ({actualUrl, fetchCallArgs, effectiveOptions, bodyForApiKeyCheck, bodyForPostMessage} = handleRequestInput(input, optionsArgument));
    } else {
      return originalFetch.apply(window, [input, optionsArgument]);
    }

    effectiveOptions.method = effectiveOptions.method || 'GET';
    if (!effectiveOptions.headers) {
      effectiveOptions.headers = new Headers();
    }


    if (typeof actualUrl === 'string' && googleLlmBaseApiUrls.some((url) => actualUrl.startsWith(url))) {
      let apiKeyIsNull = true;

      const regex = new RegExp("models/([^:]+)");
      const modelNameMatch = actualUrl.match(regex);
      const modelName = modelNameMatch ? modelNameMatch[1] : 'unspecified';


      try {
        const urlObject = new URL(actualUrl);  // Use URL object for robust parsing
        const apiKeyParam = urlObject.searchParams.get('key');
        if (apiKeyParam) {
          apiKeyIsNull = false;
        }
      } catch (e) {
        // Continue checks even if URL parsing fails
      }

      if (apiKeyIsNull && effectiveOptions.headers) {
        const h = new Headers(effectiveOptions.headers);
        const apiKeyHeaderValue = h.get('X-API-Key') || h.get('x-api-key');
        if (apiKeyHeaderValue) {
          apiKeyIsNull = false;
          return originalFetch.apply(window, fetchCallArgs);
        }
      }

      if (apiKeyIsNull && effectiveOptions.method && ['POST', 'PUT', 'PATCH'].includes(effectiveOptions.method.toUpperCase()) && typeof bodyForApiKeyCheck === 'string') {
        try {
          const bodyData = JSON.parse(bodyForApiKeyCheck);
          if (bodyData && bodyData.apiKey) {
            apiKeyIsNull = false;
            return originalFetch.apply(window, fetchCallArgs);
          }
        } catch (e) {
          // Ignore JSON parsing errors
        }
      }

      if(apiKeyIsNull) {
        const promiseId = nextPromiseId++;
        const promise = new Promise((resolve) => {
          pendingFetchResolvers[promiseId] = (resolvedResponse) => {
            delete pendingFetchResolvers[promiseId];
            resolve(resolvedResponse);
          };
        });

        let serializedBodyForPostMessage;
        if (typeof bodyForPostMessage === 'string' || bodyForPostMessage == null) {
            serializedBodyForPostMessage = bodyForPostMessage;
        } else if (bodyForPostMessage instanceof ReadableStream) {
            serializedBodyForPostMessage = null;
        } else {
            try {
                serializedBodyForPostMessage = JSON.stringify(bodyForPostMessage);
            } catch (e) {
                serializedBodyForPostMessage = null;
            }
        }

        const messageOptions = {
            method: effectiveOptions.method,
            headers: Object.fromEntries(new Headers(effectiveOptions.headers).entries()),
            body: serializedBodyForPostMessage
        };

        window.parent.postMessage({
          type: 'requestFetch',
          url: actualUrl,
          modelName: modelName,
          options: messageOptions,
          promiseId: promiseId,
        }, '*');

        return promise;
      }
      return originalFetch.apply(window, fetchCallArgs);
    }
    return originalFetch.apply(window, fetchCallArgs);
  };

  window.addEventListener('message', function(event) {
    if (event.data && event.data.type === 'resolveFetch') {
      const { promiseId, response } = event.data;
      if (pendingFetchResolvers[promiseId]) {
        try {
          const reconstructedResponse = new Response(response.body, {
            status: response.status,
            statusText: response.statusText,
            headers: new Headers(response.headers),
          });
          pendingFetchResolvers[promiseId](reconstructedResponse);
        } catch (error) {
          pendingFetchResolvers[promiseId](new Response(null, { status: 500, statusText: "Interceptor Response Reconstruction Error" }));
        }
      }
    }
  });

}))({"textModelName":"gemini-2.5-flash-preview-09-2025","imageModelName":"imagen-4.0-generate-001","imageEditModelName":"gemini-2.5-flash-image-preview","imageTransformModelName":"gemini-3-pro-image-preview-11-2025","videoModelName":"veo-2.0-generate-001","ttsModelName":"gemini-2.5-flash-preview-tts","deprecatedTextModelNames":["gemini-2.0-flash","gemini-2.5-flash-preview-04-17","gemini-2.5-flash-preview-05-20"],"deprecatedImageModelNames":["imagen-3.0-generate-001","imagen-3.0-generate-002"]})</script><script>(function() {
  const originalConsoleLog = console.log;
  const originalConsoleError = console.error;

    /**
   * Normalizes an error event or a promise rejection reason into a structured error object.
   * @param {*} errorEventOrReason The error object or reason.
   * @return {object} Structured error data { message, name, stack }.
   */
  function getErrorObject(errorEventOrReason) {
    if (errorEventOrReason instanceof Error) {
      return {
        message: errorEventOrReason.message,
        name: errorEventOrReason.name,
        stack: errorEventOrReason.stack,
      };
    }
    // Fallback for non-Error objects.
    try {
      return {
        message: JSON.stringify(errorEventOrReason),
        name: 'UnknownErrorType',
        stack: null,
      };
    } catch (e) {
      return {
        message: String(errorEventOrReason),
        name: 'UnknownErrorTypeNonStringifiable',
        stack: null,
      };
    }
  }

  /**
   * Converts an array of arguments (from log/error) into a single string.
   * Handles Error objects specially to include their message and stack.
   * @param {Array<*>} args - Arguments passed to console methods.
   * @return {string} A string representation of the arguments.
   */
  function stringifyArgs(args) {
    return args
      .map((arg) => {
        if (arg instanceof Error) {
          const {message, stack} = arg;
          return `Error: ${message}${stack ? ('\nStack: ' + stack) : ''}`;
        }
        if (typeof arg === 'object' && arg !== null) {
          try {
            return JSON.stringify(arg);
          } catch (error) {
            return '[Circular Object]';
          }
        } else {
          return String(arg);
        }
      })
      .join(' ');
  }

  console.log = function(...args) {
    const logString = stringifyArgs(args);
    window.parent.postMessage({ type: 'log', message: logString }, '*');
    originalConsoleLog.apply(console, args);
  };

  console.error = function(...args) {
    let errorData;
    if (args.length > 0 && args[0] instanceof Error) {
      const err = args[0];
      // If the first arg is an Error, capture its details.
      errorData = {
        type: 'error',
        source: 'CONSOLE_ERROR',
        ...getErrorObject(err),
        rawArgsString: stringifyArgs(args.slice(1)),
        timestamp: new Date().toISOString(),
      };
    } else {
      // If not an Error object, treat all args as a general error message.
      errorData = {
        type: 'error',
        source: 'CONSOLE_ERROR',
        message: stringifyArgs(args),
        name: 'ConsoleLoggedError',
        stack: null,
        timestamp: new Date().toISOString(),
      };
    }
    window.parent.postMessage(errorData, '*');
    originalConsoleError.apply(console, args);
  };

  // Listen for global unhandled synchronous errors.
  window.addEventListener('error', function(event) {
    const errorDetails = event.error ? getErrorObject(event.error) : {
      message: event.message,
      name: 'GlobalError',
      stack: null,
      filename: event.filename,
      lineno: event.lineno,
      colno: event.colno,
    };

    window.parent.postMessage({
      type: 'error',
      source: 'global',
      ...errorDetails,
      message: errorDetails.message || event.message,
      timestamp: new Date().toISOString(),
    }, '*');
  });

  // Listen for unhandled promise rejections (asynchronous errors).
  window.addEventListener('unhandledrejection', function(event) {
    const errorDetails = getErrorObject(event.reason);

    window.parent.postMessage({
      type: 'error',
      source: 'unhandledrejection',
      ...errorDetails,
      message: errorDetails.message || 'Unhandled Promise Rejection',
      timestamp: new Date().toISOString(),
    }, '*');
  });

})();</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Công cụ Chọn Ngẫu nhiên Cao cấp V7.3</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;500;800;900&amp;family=Orbitron:wght@400;700;900&amp;display=swap" rel="stylesheet">
    <!-- Thư viện đọc Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.mini.min.js" crossorigin="anonymous"></script>
    <style>
        :root {
            --accent-blue: #00e5ff;
            --accent-pink: #ff00ff;
            --accent-gold: #FFD700;
            --bg-deep: #050a1b;
            --royal-blue: #002299;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-deep);
            color: #fff;
            font-family: 'Exo 2', sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            transition: background 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .bg-glow {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 50% 50%, #001144 0%, #050a1b 100%);
            z-index: -2;
        }
        .bg-grid {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(rgba(0, 229, 255, 0.03) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(0, 229, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: -2;
        }

        /* Confetti Canvas */
        #confetti-canvas {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 999;
        }

        /* --- STUDIO MODE (CẤU HÌNH) --- */
        #view-config {
            height: 100%;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .studio-panel {
            width: 100%;
            max-width: 900px;
            background: rgba(10, 15, 30, 0.85);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            position: relative;
            margin: auto; 
        }

        .studio-panel::before {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 4px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-pink));
        }

        .studio-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            letter-spacing: 2px;
            margin-bottom: 30px;
            text-align: center;
            background: linear-gradient(to right, #fff, var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .control-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .custom-select {
            flex: 1;
            min-width: 200px;
            background: rgba(0,0,0,0.4);
            border: 1px solid var(--glass-border);
            color: var(--accent-blue);
            padding: 15px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            outline: none;
            cursor: pointer;
            transition: 0.3s;
        }
        .custom-select:hover { border-color: var(--accent-blue); }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            flex: 2;
        }

        .btn-studio {
            padding: 12px 15px;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            white-space: nowrap;
            flex: 1;
        }

        .btn-studio:hover {
            background: rgba(255,255,255,0.1);
            transform: translateY(-2px);
        }

        .btn-blue { color: var(--accent-blue); border-color: var(--accent-blue); }
        .btn-blue:hover { background: var(--accent-blue); color: #000; }
        .btn-magenta { color: var(--accent-pink); border-color: var(--accent-pink); }
        .btn-magenta:hover { background: var(--accent-pink); color: #fff; }
        .btn-gold { color: var(--accent-gold); border-color: var(--accent-gold); }
        .btn-gold:hover { background: var(--accent-gold); color: #000; }
        .btn-green { color: #00ff99; border-color: #00ff99; }
        .btn-green:hover { background: #00ff99; color: #000; }

        .editor-area {
            width: 100%;
            height: 220px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 20px;
            color: #ddd;
            font-family: 'Roboto Mono', monospace;
            font-size: 1rem;
            line-height: 1.6;
            resize: none;
            margin-bottom: 25px;
            transition: 0.3s;
        }
        .editor-area:focus {
            border-color: var(--accent-blue);
            background: rgba(0,0,0,0.5);
            outline: none;
        }

        .footer-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #556080;
            font-size: 0.85rem;
            margin-bottom: 25px;
        }

        .btn-launch {
            width: 100%;
            padding: 22px;
            font-family: 'Exo 2', sans-serif;
            font-size: 1.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, #0044ff, #002299);
            color: #fff;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            letter-spacing: 2px;
            text-transform: uppercase;
            box-shadow: 0 10px 30px rgba(0, 34, 153, 0.4);
            transition: 0.4s;
        }
        .btn-launch:hover {
            transform: scale(1.02);
            box-shadow: 0 15px 40px rgba(0, 34, 153, 0.6);
            filter: brightness(1.2);
        }

        /* --- PICKER MODE (TRÌNH CHIẾU) --- */
        #view-picker {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: var(--royal-blue);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            background: radial-gradient(circle at center, #002299 0%, #001144 100%);
        }

        #result-container {
            width: 95%; /* Mở rộng chiều ngang cho mobile */
            height: 60vh; 
            display: flex;
            align-items: center;
            justify-content: center;
            /* Đẩy nội dung lên cao một chút để tránh bàn phím ảo hoặc thanh điều hướng */
            margin-bottom: 5vh; 
            overflow: hidden; /* Tránh tràn layout */
        }

        #result-name {
            font-size: clamp(3rem, 12vw, 9rem);
            font-weight: 900;
            text-align: center;
            width: 100%;
            padding: 10px;
            line-height: 1.2;
            word-wrap: break-word;
            text-transform: uppercase;
            color: #fff;
            text-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: color 0.3s, text-shadow 0.3s; /* Bỏ transition font-size để tránh giật khi fitText */
            white-space: normal;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .picker-hud {
            position: absolute;
            bottom: 30px; /* Thấp hơn một chút */
            display: flex;
            gap: 20px;
            align-items: center;
            width: 95%;
            justify-content: center;
            flex-wrap: wrap;
            z-index: 1001; 
            padding-bottom: env(safe-area-inset-bottom); /* Hỗ trợ iPhone X+ */
        }

        .btn-random {
            background: #FFFFFF;
            color: var(--royal-blue);
            font-family: 'Exo 2', sans-serif;
            font-size: clamp(1.2rem, 4vw, 2.2rem);
            font-weight: 900;
            padding: 1.2em 3em;
            border: none;
            border-radius: 100px;
            cursor: pointer;
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
            transition: all 0.2s;
            text-transform: uppercase;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .btn-random:hover {
            transform: scale(1.05) translateY(-3px);
            background: #f0f0f0;
        }
        .btn-random:active { transform: scale(0.95); }

        .btn-util {
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            padding: 15px 30px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 100px;
            cursor: pointer;
            backdrop-filter: blur(5px);
            transition: 0.3s;
            white-space: nowrap;
        }
        .btn-util:hover { background: rgba(255,255,255,0.2); border-color: #fff; }

        .btn-exit {
            position: absolute;
            top: 20px; left: 20px;
            color: rgba(255,255,255,0.6);
            font-size: 0.9rem;
            text-decoration: none;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.3s;
            background: rgba(0,0,0,0.2);
            padding: 8px 16px;
            border-radius: 30px;
            z-index: 1001;
            top: max(20px, env(safe-area-inset-top)); /* Hỗ trợ iPhone tai thỏ */
        }
        .btn-exit:hover { color: #fff; background: rgba(0,0,0,0.4); }

        /* WINNER EFFECT */
        .winner-active {
            color: var(--accent-gold) !important;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.8), 0 0 80px rgba(255, 215, 0, 0.6) !important;
            animation: winnerGlow 0.6s infinite alternate cubic-bezier(0.45, 0.05, 0.55, 0.95);
        }

        @keyframes winnerGlow {
            from { transform: scale(1); filter: brightness(1); }
            to { transform: scale(1.1); filter: brightness(1.3); }
        }

        .author-credit {
            position: fixed;
            bottom: 10px;
            right: 15px;
            font-family: 'Exo 2', sans-serif;
            font-size: 0.75rem;
            color: var(--accent-gold);
            opacity: 0.6;
            z-index: 200;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.2);
            pointer-events: none;
            font-weight: 500;
        }

        /* --- RESPONSIVE BREAKPOINTS --- */
        
        /* Tablet & iPad (Portrait & Landscape) */
        @media (min-width: 768px) and (max-width: 1180px) {
            .studio-panel { max-width: 90%; padding: 30px; }
            #result-container { height: 55vh; margin-bottom: 2vh; }
            .picker-hud { bottom: 60px; gap: 25px; }
            .btn-random { font-size: 2.5rem; padding: 25px 50px; }
            .btn-util { font-size: 1.1rem; padding: 18px 35px; }
        }

        /* Mobile */
        @media (max-width: 767px) {
            /* Config Screen */
            #view-config { align-items: flex-start; padding: 10px; } 
            .studio-panel { padding: 20px; margin-top: 20px; margin-bottom: 80px;} /* Thêm margin bottom để không bị che */
            .studio-title { font-size: 1.4rem; }
            .control-row { flex-direction: column; gap: 15px; }
            .btn-group { display: grid; grid-template-columns: 1fr 1fr; width: 100%; gap: 8px; }
            .custom-select { width: 100%; }
            .btn-launch { font-size: 1.3rem; padding: 18px; position: sticky; bottom: 0; z-index: 10; margin-top: 10px; box-shadow: 0 -5px 20px rgba(0,0,0,0.3); }
            .editor-area { height: 180px; font-size: 14px; }

            /* Picker Screen */
            #result-container { height: 55vh; margin-top: 0; width: 98%; }
            .picker-hud { flex-direction: column; bottom: 30px; gap: 15px; width: 100%; }
            .btn-random { width: 85%; padding: 20px 0; font-size: 1.8rem; }
            .btn-util { width: 60%; padding: 12px 0; font-size: 0.8rem; }
            .btn-exit { top: 15px; left: 15px; font-size: 0.8rem; padding: 6px 12px; }
            .author-credit { font-size: 0.6rem; bottom: 5px; right: 10px; text-align: right; width: 100%; padding-right: 10px;}
        }

        /* MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 5, 15, 0.95);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none;
            align-items: center; justify-content: center;
            padding: 20px;
        }

        .modal-box {
            background: #0a0f1d;
            border: 1px solid var(--accent-blue);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            text-align: center;
            box-shadow: 0 0 50px rgba(0, 229, 255, 0.15);
        }

        .modal-title {
            color: var(--accent-blue);
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            margin-bottom: 15px;
        }

        .modal-btns {
            display: flex; gap: 10px; justify-content: center; margin-top: 25px; flex-wrap: wrap;
        }

        .m-btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-weight: 800;
            cursor: pointer;
            font-family: 'Exo 2';
            transition: 0.2s;
            flex: 1;
            min-width: 100px;
        }
        .m-btn-primary { background: var(--accent-blue); color: #000; }
        .m-btn-danger { background: #ff1744; color: #fff; }
        .m-btn-secondary { background: #222; color: #aaa; }
    </style>
</head>
<body>

    <div class="bg-glow"></div>
    <div class="bg-grid"></div>
    <canvas id="confetti-canvas" width="1536" height="730"></canvas>
    <div class="author-credit">Nguyễn Trường Sinh - THPT Định Quán</div>

    <!-- MÀN HÌNH CẤU HÌNH -->
    <section id="view-config" style="display: flex;">
        <div class="studio-panel">
            <h1 class="studio-title">PHÒNG ĐIỀU KHIỂN QUAY SỐ</h1>
            
            <div class="control-row">
                <select id="class-select" class="custom-select" onchange="handleClassChange()"><option value="12A2">12A2</option><option value="NHÓM">NHÓM</option><option value="NHÓM 1">NHÓM 1</option><option value="NHÓM 2">NHÓM 2</option><option value="NHÓM 3">NHÓM 3</option><option value="NHÓM 4">NHÓM 4</option></select>
                <!-- File Input Ẩn -->
                <input type="file" id="excel-input" accept=".xlsx, .xls" style="display: none;" onchange="handleExcelUpload(this)">
                
                <div class="btn-group">
                    <button class="btn-studio btn-blue" onclick="promptAddClass()">+ Thêm</button>
                    <button class="btn-studio btn-green" onclick="triggerExcelUpload()">Nhập Excel</button>
                    <button class="btn-studio btn-gold" onclick="actionSaveClass()">Lưu Data</button>
                    <button class="btn-studio btn-magenta" onclick="actionExportFile()">Tải HTML</button>
                    <button class="btn-studio" onclick="confirmDeleteClass()">Xóa</button>
                </div>
            </div>

            <textarea id="student-list" class="editor-area" placeholder="Nhập danh sách học sinh (Mỗi tên một dòng) hoặc dùng nút Nhập Excel..." oninput="handleAutoSave()"></textarea>
            
            <div class="footer-info">
                <span>Tự động lưu trong trình duyệt</span>
                <span id="stat-count" style="color: var(--accent-blue); font-weight: bold;">44 Học sinh</span>
            </div>

            <button class="btn-launch" onclick="launchPicker()">CHỌN NGẪU NHIÊN</button>
        </div>
    </section>

    <!-- MÀN HÌNH TRÌNH CHIẾU -->
    <section id="view-picker" style="display: none;">
        <a href="#" class="btn-exit" onclick="exitPicker()">← Quay lại Cài đặt</a>
        
        <div id="result-container">
            <div id="result-name" class="">ĐÃ ĐẶT LẠI</div>
        </div>

        <div class="picker-hud">
            <button id="btn-spin" class="btn-random" onclick="startRolling()">CHỌN NGẪU NHIÊN</button>
            <button class="btn-util" onclick="actionResetList()">ĐẶT LẠI DANH SÁCH</button>
        </div>
    </section>

    <!-- MODAL -->
    <div id="modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-box">
            <h3 id="modal-title" class="modal-title">THÔNG BÁO</h3>
            <p id="modal-body" style="line-height:1.6; color:#aaa;">Đã khôi phục danh sách đầy đủ.</p>
            <input type="text" id="modal-input" style="width:100%; padding:15px; background:#000; border:1px solid #333; color:#fff; margin-top:20px; border-radius:10px; display:none;">
            <div id="modal-btns" class="modal-btns"><button class="m-btn m-btn-primary">ĐÃ HIỂU</button></div>
        </div>
    </div>

    <script id="app-core">
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const STORAGE_DATA = 'picker_v7_data';
        const STORAGE_ACTIVE = 'picker_v7_active';

        // --- KHỐI DỮ LIỆU ĐÓNG GÓI ---
        /* DATA_START */
        let appData = {
    "12A2": {
        "current": "Lê Ngọc Quỳnh\tAnh\nLê Nguyễn Phương Anh\nLê Phạm Tuấn\tAnh\nNgô Quỳnh\tAnh\nNguyễn Lê Minh\tAnh\nCún Tiểu\tBảo\nPhạm Lâm Thái\tBảo\nNguyễn Ngọc\tBích\nDìu Triệu\tBình\nNguyễn Công\tDanh\nLê Đỗ Mỹ\tDuyên\nPhùng Mỹ\tDuyên\nNguyễn Quốc\tĐại\nPhan Anh\tĐạt\nTrần Duy\tHùng\nLỷ Thu\tHương\nHồ Nhịn\tKhang\nTrần Mạnh\tKhang\nNguyễn Thị Mỹ\tLan\nNìm Thảo\tLiên\nPhan Ngọc Trà\tMy\nHáu Yến\tNhi\nNguyễn Thị Lan\tNhi\nNguyễn Lâm Tâm\tNhư\nĐinh Ngọc Tường\tPhát\nTrần Quang Vy\tPhát\nNguyễn Đăng\tQuang\nDương Nguyễn Anh\tQuân\nHồ Anh\tQuân\nĐỗ Ngọc Hương\tQuỳnh\nLương Nguyễn Như\tQuỳnh\nNguyễn Thị Như\tQuỳnh\nTrần Thị Kim\tThoa\nVòng Kim\tThủy\nCung Anh\tThư\nLê Trần Ngọc Bảo\tThy\nNguyễn Hoàng Bảo\tThy\nHồ Trung\tTín\nNguyễn Đức Minh\tTrí\nNguyễn Trần Mỹ\tTrinh\nHoàng Trần Nhật\tTuân\nNguyễn Hoàng Phương\tUyên\nNguyễn Anh\tVũ\nHuỳnh Thị Hồng\tYến\n",
        "original": "Lê Ngọc Quỳnh\tAnh\nLê Nguyễn Phương Anh\nLê Phạm Tuấn\tAnh\nNgô Quỳnh\tAnh\nNguyễn Lê Minh\tAnh\nCún Tiểu\tBảo\nPhạm Lâm Thái\tBảo\nNguyễn Ngọc\tBích\nDìu Triệu\tBình\nNguyễn Công\tDanh\nLê Đỗ Mỹ\tDuyên\nPhùng Mỹ\tDuyên\nNguyễn Quốc\tĐại\nPhan Anh\tĐạt\nTrần Duy\tHùng\nLỷ Thu\tHương\nHồ Nhịn\tKhang\nTrần Mạnh\tKhang\nNguyễn Thị Mỹ\tLan\nNìm Thảo\tLiên\nPhan Ngọc Trà\tMy\nHáu Yến\tNhi\nNguyễn Thị Lan\tNhi\nNguyễn Lâm Tâm\tNhư\nĐinh Ngọc Tường\tPhát\nTrần Quang Vy\tPhát\nNguyễn Đăng\tQuang\nDương Nguyễn Anh\tQuân\nHồ Anh\tQuân\nĐỗ Ngọc Hương\tQuỳnh\nLương Nguyễn Như\tQuỳnh\nNguyễn Thị Như\tQuỳnh\nTrần Thị Kim\tThoa\nVòng Kim\tThủy\nCung Anh\tThư\nLê Trần Ngọc Bảo\tThy\nNguyễn Hoàng Bảo\tThy\nHồ Trung\tTín\nNguyễn Đức Minh\tTrí\nNguyễn Trần Mỹ\tTrinh\nHoàng Trần Nhật\tTuân\nNguyễn Hoàng Phương\tUyên\nNguyễn Anh\tVũ\nHuỳnh Thị Hồng\tYến\n"
    },
    "NHÓM": {
        "current": "NHÓM 1\nNHÓM 2\nNHÓM 3\nNHÓM 4",
        "original": "NHÓM 1\nNHÓM 2\nNHÓM 3\nNHÓM 4"
    },
    "NHÓM 1": {
        "current": "Lê Đ Mỹ Duyên\nLê N Quỳnh Anh\nĐinh Ngọc Tường Phát\ncúnTiểu Bảo\nPham lâmThái Bảo\nLê phạm Tuấn Anh\nHồ Anh Quân\nNguyễn Hoàng Bảo Thy\nCungAnh thư\nVòng Kim Thủy\nĐỗ Hương quỳnh\nNguyễn Quốc Đại",
        "original": "Lê Đ Mỹ Duyên\nLê N Quỳnh Anh\nĐinh Ngọc Tường Phát\ncúnTiểu Bảo\nPham lâmThái Bảo\nLê phạm Tuấn Anh\nHồ Anh Quân\nNguyễn Hoàng Bảo Thy\nCungAnh thư\nVòng Kim Thủy\nĐỗ Hương quỳnh\nNguyễn Quốc Đại"
    },
    "NHÓM 2": {
        "current": "Phan Anh Đạt\nNguyễn Thị Như Quỳnh\nNguyễn Anh Vũ\nNguyễn Đăng Quang\nNguyễn Lâm Tâm Như\nLê Nguyễn Phương Anh\nTrần Mạnh Khang\nDìu Triệu Bình\nLê Trần Ngọc Bảo Thy\nNguyễn Thị Mỹ Lan\nNguyễn Thị Lan Nhi",
        "original": "Phan Anh Đạt\nNguyễn Thị Như Quỳnh\nNguyễn Anh Vũ\nNguyễn Đăng Quang\nNguyễn Lâm Tâm Như\nLê Nguyễn Phương Anh\nTrần Mạnh Khang\nDìu Triệu Bình\nLê Trần Ngọc Bảo Thy\nNguyễn Thị Mỹ Lan\nNguyễn Thị Lan Nhi"
    },
    "NHÓM 3": {
        "current": "Huỳnh Thị Hồng Yến\nNguyễn Hoàng Phương Uyên\nTrần Duy Hùng\nNguyễn Công Danh\nPhan Ngọc Trà My\nLìm Thảo Liên\nLỷ Thu Hương\nLương Nguyễn Như Quỳnh\nNguyễn Đức Minh Trí\nTrần Thị Kim Thoa\nTrần Quang Vy Phát",
        "original": "Huỳnh Thị Hồng Yến\nNguyễn Hoàng Phương Uyên\nTrần Duy Hùng\nNguyễn Công Danh\nPhan Ngọc Trà My\nLìm Thảo Liên\nLỷ Thu Hương\nLương Nguyễn Như Quỳnh\nNguyễn Đức Minh Trí\nTrần Thị Kim Thoa\nTrần Quang Vy Phát"
    },
    "NHÓM 4": {
        "current": "Phùng Mỹ Duyên\nHáu Yến Nhi\nNguyễn Lê Minh Anh\nHoàng Trần Nhật Tuân\nHồ Nhịn Khang\nHồ Trung Tín\nNguyễn Trần Mỹ Trinh\nNguyễn Ngọc Bích\nNgô Quỳnh Anh\nDương Nguyễn Anh Quân",
        "original": "Phùng Mỹ Duyên\nHáu Yến Nhi\nNguyễn Lê Minh Anh\nHoàng Trần Nhật Tuân\nHồ Nhịn Khang\nHồ Trung Tín\nNguyễn Trần Mỹ Trinh\nNguyễn Ngọc Bích\nNgô Quỳnh Anh\nDương Nguyễn Anh Quân"
    }
};
        let activeClass = "12A2";
        let isExported = true;
            /* DATA_END */
        
        let isSpinning = false;
        let confettiCtx = null;
        let confettiActive = false;
        let particles = [];

        // --- UNLOCK AUDIO ON INTERACTION (FIX MOBILE) ---
        function unlockAudio() {
            if (audioCtx.state === 'suspended') {
                audioCtx.resume().then(() => console.log('Audio Context Resumed'));
            }
            document.removeEventListener('click', unlockAudio);
            document.removeEventListener('touchstart', unlockAudio);
        }
        document.addEventListener('click', unlockAudio);
        document.addEventListener('touchstart', unlockAudio);

        // --- NAVIGATION ---
        function launchPicker() {
            const list = getStudents();
            if(list.length === 0) return alertModal("Lớp học này chưa có danh sách học sinh!");
            document.getElementById('view-config').style.display = 'none';
            document.getElementById('view-picker').style.display = 'flex';
        }

        function exitPicker() {
            document.getElementById('view-picker').style.display = 'none';
            document.getElementById('view-config').style.display = 'flex';
            stopConfetti();
            refreshStudioUI();
        }

        // --- APP INIT ---
        function initApp() {
            initConfetti();
            if (isExported) {
                saveAllStorage();
            } else {
                const saved = localStorage.getItem(STORAGE_DATA);
                if(saved) {
                    try { appData = JSON.parse(saved); } catch(e) {}
                }
                const active = localStorage.getItem(STORAGE_ACTIVE);
                if(active && appData[active]) activeClass = active;
                else activeClass = Object.keys(appData)[0] || "12A2";
            }
            populateClassSelect();
            refreshStudioUI();
        }

        function populateClassSelect() {
            const sel = document.getElementById('class-select');
            sel.innerHTML = '';
            Object.keys(appData).sort().forEach(name => {
                const opt = document.createElement('option');
                opt.value = name; opt.text = name;
                if(name === activeClass) opt.selected = true;
                sel.appendChild(opt);
            });
        }

        function handleClassChange() {
            activeClass = document.getElementById('class-select').value;
            localStorage.setItem(STORAGE_ACTIVE, activeClass);
            refreshStudioUI();
            document.getElementById('result-name').innerText = "SẴN SÀNG";
            document.getElementById('result-name').style.fontSize = "";
            document.getElementById('result-name').classList.remove('winner-active');
            stopConfetti();
        }

        function refreshStudioUI() {
            const area = document.getElementById('student-list');
            area.value = appData[activeClass]?.current || "";
            document.getElementById('stat-count').innerText = `${getStudents().length} Học sinh`;
        }

        function handleAutoSave() {
            if(!appData[activeClass]) return;
            appData[activeClass].current = document.getElementById('student-list').value;
            localStorage.setItem(STORAGE_DATA, JSON.stringify(appData));
            document.getElementById('stat-count').innerText = `${getStudents().length} Học sinh`;
        }

        function getStudents() {
            return document.getElementById('student-list').value.split('\n').map(s => s.trim()).filter(s => s.length > 0);
        }

        function actionSaveClass() {
            const val = document.getElementById('student-list').value;
            appData[activeClass].original = val;
            appData[activeClass].current = val;
            localStorage.setItem(STORAGE_DATA, JSON.stringify(appData));
            alertModal(`Đã lưu dữ liệu gốc cho lớp "${activeClass}".`);
        }

        function actionResetList() {
            if(isSpinning) return;
            appData[activeClass].current = appData[activeClass].original;
            localStorage.setItem(STORAGE_DATA, JSON.stringify(appData));
            document.getElementById('result-name').innerText = "ĐÃ ĐẶT LẠI";
            document.getElementById('result-name').style.fontSize = "";
            document.getElementById('result-name').classList.remove('winner-active');
            stopConfetti();
            refreshStudioUI();
            alertModal("Đã khôi phục danh sách đầy đủ.");
        }

        function promptAddClass() {
            customPrompt("Nhập tên lớp học mới:", (name) => {
                const clean = name ? name.trim() : "";
                if(!clean) return;
                if(appData[clean]) return alertModal("Lớp học đã tồn tại!");
                appData[clean] = { current: "", original: "" };
                activeClass = clean;
                saveAllStorage();
                populateClassSelect();
                refreshStudioUI();
            });
        }

        function confirmDeleteClass() {
            if(Object.keys(appData).length <= 1) return alertModal("Không thể xóa lớp cuối cùng!");
            customConfirm(`Xác nhận xóa vĩnh viễn lớp "${activeClass}"?`, () => {
                delete appData[activeClass];
                activeClass = Object.keys(appData)[0];
                saveAllStorage();
                populateClassSelect();
                refreshStudioUI();
            });
        }

        function saveAllStorage() {
            localStorage.setItem(STORAGE_DATA, JSON.stringify(appData));
            localStorage.setItem(STORAGE_ACTIVE, activeClass);
        }

        // --- EXCEL IMPORT ---
        function triggerExcelUpload() {
            document.getElementById('excel-input').click();
        }

        function handleExcelUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                try {
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    let names = [];

                    json.forEach(row => {
                        let val = null;
                        const isText = (v) => {
                            if (!v) return false;
                            const s = String(v).trim();
                            if (!isNaN(s) && !isNaN(parseFloat(s))) return false;
                            return true;
                        };
                        if (isText(row[1])) val = row[1];
                        else if (isText(row[0])) val = row[0];

                        if (val) {
                            let str = String(val).trim();
                            const skipWords = ["stt", "họ và tên", "họ tên", "tên", "số thứ tự", "name", "full name"];
                            if (!skipWords.includes(str.toLowerCase()) && str.length > 1) {
                                names.push(str);
                            }
                        }
                    });

                    if (names.length > 0) {
                        const newContent = names.join('\n');
                        const currentContent = document.getElementById('student-list').value;
                        
                        customConfirm(`Tìm thấy ${names.length} tên (đã lọc số thứ tự).\nBạn muốn THAY THẾ toàn bộ hay GỘP thêm vào danh sách hiện tại?`, 
                            () => { 
                                document.getElementById('student-list').value = newContent;
                                handleAutoSave();
                                alertModal("Đã nhập dữ liệu thành công!");
                            },
                            () => { 
                                document.getElementById('student-list').value = currentContent + (currentContent ? '\n' : '') + newContent;
                                handleAutoSave();
                                alertModal("Đã gộp dữ liệu thành công!");
                            },
                            "THAY THẾ", "GỘP THÊM"
                        );
                    } else {
                        alertModal("Không tìm thấy tên hợp lệ!\n(Lưu ý: Hệ thống đã tự động bỏ qua các cột chứa số).");
                    }
                } catch (err) {
                    console.error(err);
                    alertModal("Lỗi khi đọc file Excel. Vui lòng thử lại!");
                }
                input.value = '';
            };
            reader.readAsArrayBuffer(file);
        }

        // --- PICKER ENGINE ---
        function startRolling() {
            if(isSpinning) return;
            stopConfetti();
            const pool = getStudents();
            if(pool.length === 0) return alertModal("Danh sách trống! Vui lòng nhấn Đặt lại.");

            isSpinning = true;
            document.getElementById('btn-spin').disabled = true;
            const display = document.getElementById('result-name');
            display.classList.remove('winner-active');
            display.style.fontSize = ""; 

            let delay = 15;
            const maxDelay = 500;
            const factor = 1.09;

            function step() {
                const winner = pool[Math.floor(Math.random() * pool.length)];
                display.innerText = winner;
                playTick();

                if(delay < maxDelay) {
                    delay *= factor;
                    setTimeout(step, delay);
                } else {
                    finalizeWinner(winner);
                }
            }
            step();
        }

        function finalizeWinner(winner) {
            isSpinning = false;
            document.getElementById('btn-spin').disabled = false;
            const display = document.getElementById('result-name');
            
            // CẬP NHẬT: Hiển thị tên và reset font-size về rỗng để dùng style mặc định (giống lúc quay)
            display.innerText = winner;
            display.style.fontSize = ""; 
            
            display.classList.add('winner-active');
            playWinSound(); 
            fireConfetti();

            setTimeout(() => {
                customConfirm(`CHÚC MỪNG: ${winner}!\nBạn có muốn XÓA tên này khỏi danh sách quay tiếp theo không?`, () => {
                    const newList = getStudents().filter(n => n !== winner);
                    document.getElementById('student-list').value = newList.join('\n');
                    handleAutoSave();
                }, () => {}, "XÓA TÊN", "GIỮ LẠI");
            }, 1000); 
        }

        // --- CẢI TIẾN LOGIC PHÓNG TO CHỮ (Không còn sử dụng ở phiên bản này) ---
        function fitText(element, text) {
            // Hàm này đã được vô hiệu hóa để giữ kích thước chữ đồng nhất
        }

        // --- AUDIO ---
        function playTick() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.connect(g); g.connect(audioCtx.destination);
            
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(600, audioCtx.currentTime);
            g.gain.setValueAtTime(0.1, audioCtx.currentTime);
            g.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            
            osc.start(); 
            osc.stop(audioCtx.currentTime + 0.1);
        }

        function playWinSound() {
            const notes = [523.25, 659.25, 783.99, 1046.50]; 
            const now = audioCtx.currentTime;
            
            notes.forEach((freq, i) => {
                const osc = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                osc.connect(g); g.connect(audioCtx.destination);
                
                osc.type = 'square';
                osc.frequency.value = freq;
                
                const start = now + (i * 0.1);
                g.gain.setValueAtTime(0, start);
                g.gain.linearRampToValueAtTime(0.1, start + 0.05);
                g.gain.exponentialRampToValueAtTime(0.001, start + 0.4);
                
                osc.start(start);
                osc.stop(start + 0.4);
            });
            
            const osc2 = audioCtx.createOscillator();
            const g2 = audioCtx.createGain();
            osc2.connect(g2); g2.connect(audioCtx.destination);
            osc2.type = 'sine';
            osc2.frequency.setValueAtTime(1046.50, now + 0.3); // High C
            g2.gain.setValueAtTime(0, now + 0.3);
            g2.gain.linearRampToValueAtTime(0.15, now + 0.35);
            g2.gain.exponentialRampToValueAtTime(0.001, now + 1.2);
            osc2.start(now + 0.3);
            osc2.stop(now + 1.2);
        }

        // --- CONFETTI SYSTEM ---
        function initConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            confettiCtx = canvas.getContext('2d');
            const resize = () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            };
            window.addEventListener('resize', resize);
            resize();
        }

        function fireConfetti() {
            confettiActive = true;
            particles = [];
            const colors = ['#00e5ff', '#ff00ff', '#FFD700', '#ffffff', '#00ff00'];
            
            for(let i=0; i<200; i++) {
                particles.push({
                    x: window.innerWidth / 2,
                    y: window.innerHeight / 2,
                    vx: (Math.random() - 0.5) * 25,
                    vy: (Math.random() - 0.5) * 25 - 5,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    size: Math.random() * 8 + 4,
                    life: 150,
                    rotation: Math.random() * 360,
                    rotationSpeed: (Math.random() - 0.5) * 10
                });
            }
            requestAnimationFrame(updateConfetti);
        }

        function updateConfetti() {
            if(!confettiActive) {
                confettiCtx.clearRect(0,0, window.innerWidth, window.innerHeight);
                return;
            }
            confettiCtx.clearRect(0,0, window.innerWidth, window.innerHeight);
            let alive = false;
            particles.forEach(p => {
                if(p.life > 0) {
                    alive = true;
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.4; 
                    p.vx *= 0.96; 
                    p.rotation += p.rotationSpeed;
                    p.life--;
                    confettiCtx.save();
                    confettiCtx.translate(p.x, p.y);
                    confettiCtx.rotate(p.rotation * Math.PI / 180);
                    confettiCtx.fillStyle = p.color;
                    confettiCtx.globalAlpha = p.life / 100;
                    confettiCtx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
                    confettiCtx.restore();
                }
            });
            if(alive) requestAnimationFrame(updateConfetti);
            else confettiActive = false;
        }

        function stopConfetti() {
            confettiActive = false;
            if(confettiCtx) confettiCtx.clearRect(0,0, window.innerWidth, window.innerHeight);
        }

        // --- EXPORT FUNCTION ---
        function actionExportFile() {
            if (appData[activeClass]) {
                appData[activeClass].current = document.getElementById('student-list').value;
            }
            saveAllStorage();

            const dataStr = JSON.stringify(appData, null, 4).replace(/<\/script>/g, "<\\/script>");
            const activeString = activeClass.replace(/"/g, '\\"');
            
            const newContent = `
        let appData = ${dataStr};
        let activeClass = "${activeString}";
        let isExported = true;
            `;

            let fullHTML = document.documentElement.outerHTML;
            const regex = /\/\* DATA_START \*\/[\s\S]*?\/\* DATA_END \*\//;
            
            if (regex.test(fullHTML)) {
                fullHTML = fullHTML.replace(regex, `/* DATA_START */${newContent}/* DATA_END */`);
            } else {
                alertModal("Lỗi: Không tìm thấy khối dữ liệu gốc. Vui lòng tải lại trang.");
                return;
            }

            const blob = new Blob([fullHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const date = new Date().toISOString().slice(0,10);
            a.download = `RandomPicker_Data_${date}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            alertModal("Xuất file thành công! Toàn bộ dữ liệu lớp học và danh sách đã được lưu vào file HTML này.");
        }

        // --- MODAL UTILS ---
        function alertModal(msg) {
            showGeneralModal({ title: "THÔNG BÁO", msg, buttons: [{text: "ĐÃ HIỂU", class: "m-btn-primary"}] });
        }

        function customPrompt(msg, callback) {
            showGeneralModal({ title: "NHẬP DỮ LIỆU", msg, input: true, buttons: [
                {text: "HỦY", class: "m-btn-secondary"},
                {text: "TẠO", class: "m-btn-primary", onClick: callback}
            ]});
        }

        function customConfirm(msg, onYes, onNo, yesText="XÁC NHẬN", noText="HỦY") {
            showGeneralModal({ title: "XÁC NHẬN", msg, buttons: [
                {text: noText, class: "m-btn-secondary", onClick: onNo},
                {text: yesText, class: "m-btn-danger", onClick: onYes}
            ]});
        }

        function showGeneralModal({title, msg, input, buttons}) {
            const m = document.getElementById('modal-overlay');
            const btns = document.getElementById('modal-btns');
            const inp = document.getElementById('modal-input');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-body').innerText = msg;
            if(input) { inp.style.display = 'block'; inp.value = ''; setTimeout(()=>inp.focus(), 100); }
            else { inp.style.display = 'none'; }
            btns.innerHTML = '';
            buttons.forEach(b => {
                const btn = document.createElement('button');
                btn.className = `m-btn ${b.class}`;
                btn.innerText = b.text;
                btn.onclick = () => {
                    if(b.onClick) b.onClick(inp.value);
                    m.style.display = 'none';
                };
                btns.appendChild(btn);
            });
            m.style.display = 'flex';
        }

        window.onload = initApp;
    </script>


</body></html>
